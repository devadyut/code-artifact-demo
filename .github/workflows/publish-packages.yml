# GitHub Actions Workflow for CodeArtifact Package Publishing
# 
# This workflow runs on AWS CodeBuild managed runners for package publishing.
# Uses CodeBuild infrastructure directly instead of GitHub-hosted runners.
# 
# INFRASTRUCTURE:
# - Uses CodeBuild managed runner: codebuild-publish-packages-to-codeartifact
# - Build Environment: Amazon Linux 2, x86_64, Standard 7.0
# - Compute: BUILD_GENERAL1_SMALL
# - Service Role: CodeBuildServiceRole-PackagePublishing with CodeArtifact permissions
# 
# AUTOMATIC TRIGGERING:
# - Triggers on push to main branch with changes in my-lib/**
# - Primary method should be CodeBuild webhook (faster, more direct)
# 
# MANUAL TRIGGERING:
# - Use when CodeBuild webhook is not working
# - Go to Actions tab â†’ "Publish Packages to CodeArtifact" â†’ "Run workflow"
# - Options:
#   - package_scope: Choose what to publish (individual-only, aggregate-and-above, main-only, full-pipeline)
#   - force_publish: Force publish even without detected changes
# 
# WHEN TO USE MANUAL TRIGGER:
# - CodeBuild webhook is not responding
# - Testing the CodeBuild managed runner
# - Emergency package publishing
# - Debugging build issues on CodeBuild infrastructure
#
name: Publish Packages to CodeArtifact

# Configuration - Update these values to match your CodeBuild setup
# These should match the values used in scripts/setup-codebuild.js
env:
  CODEBUILD_PROJECT_NAME: publish-packages-to-codeartifact  # Must match PROJECT_NAME in setup-codebuild.js
  LOG_GROUP_NAME: /aws/codebuild/publish-packages-to-codeartifact
  # CodeBuild infrastructure configuration
  CODEBUILD_REGION: ${{ secrets.AWS_REGION }}
  CODEBUILD_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

on:
  # Primary trigger: Push to main branch with my-lib changes
  push:
    branches: [ main ]
    paths:
      - 'my-lib/**'
  
  # Manual/fallback trigger: Use when CodeBuild webhook is not working
  workflow_dispatch:
    inputs:
      package_scope:
        description: 'Publishing scope'
        required: true
        default: 'full-pipeline'
        type: choice
        options:
          - individual-only
          - aggregate-and-above
          - main-only
          - full-pipeline
      force_publish:
        description: 'Force publish even without detected changes'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  detect-changes:
    runs-on: codebuild-publish-packages-to-codeartifact-${{ github.run_id }}-${{ github.run_attempt }}
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    outputs:
      services-changed: ${{ steps.changes.outputs.services }}
      utilities-changed: ${{ steps.changes.outputs.utilities }}
      individual-services: ${{ steps.individual-changes.outputs.services }}
      individual-utilities: ${{ steps.individual-changes.outputs.utilities }}
      should-publish-services-aggregate: ${{ steps.dependency-chain.outputs.should-publish-services-aggregate }}
      should-publish-utilities-aggregate: ${{ steps.dependency-chain.outputs.should-publish-utilities-aggregate }}
      should-publish-main-package: ${{ steps.dependency-chain.outputs.should-publish-main-package }}
      publishing-scope: ${{ steps.dependency-chain.outputs.publishing-scope }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Detect package changes
        id: changes
        run: |
          # Handle force publish scenario for manual dispatch
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_publish }}" == "true" ]; then
            echo "Force publish enabled - including all packages"
            echo "services=true" >> $GITHUB_OUTPUT
            echo "utilities=true" >> $GITHUB_OUTPUT
          else
            # Check for changes in services and utilities directories
            if git diff --name-only HEAD~1 HEAD | grep -q '^my-lib/services/'; then
              echo "services=true" >> $GITHUB_OUTPUT
            else
              echo "services=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only HEAD~1 HEAD | grep -q '^my-lib/utilities/'; then
              echo "utilities=true" >> $GITHUB_OUTPUT
            else
              echo "utilities=false" >> $GITHUB_OUTPUT
            fi
          fi
      - name: Detect individual package changes
        id: individual-changes
        run: |
          # Handle force publish scenario for manual dispatch
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_publish }}" == "true" ]; then
            echo "Force publish enabled - including all packages"
            SERVICES_JSON='["database","storage"]'
            UTILITIES_JSON='["array","constants","date","error","logger","middleware","response","validation"]'
          else
            # Detect changed service packages (exclude root package.json)
            SERVICES=$(git diff --name-only HEAD~1 HEAD | grep '^my-lib/services/' | grep -v '^my-lib/services/package\.json' | cut -d'/' -f3 | sort -u | tr '\n' ' ')
            if [ -n "$SERVICES" ]; then
              SERVICES_JSON=$(echo "$SERVICES" | sed 's/ *$//' | sed 's/ /","/g' | sed 's/^/["/' | sed 's/$/"]/')
            else
              # If no individual changes detected but services changed, publish all services
              if [ "${{ steps.changes.outputs.services }}" == "true" ]; then
                SERVICES_JSON='["database","storage"]'
              else
                SERVICES_JSON="[]"
              fi
            fi
            
            # Detect changed utility packages (exclude root package.json)
            UTILITIES=$(git diff --name-only HEAD~1 HEAD | grep '^my-lib/utilities/' | grep -v '^my-lib/utilities/package\.json' | cut -d'/' -f3 | sort -u | tr '\n' ' ')
            if [ -n "$UTILITIES" ]; then
              UTILITIES_JSON=$(echo "$UTILITIES" | sed 's/ *$//' | sed 's/ /","/g' | sed 's/^/["/' | sed 's/$/"]/')
            else
              # If no individual changes detected but utilities changed, publish all utilities
              if [ "${{ steps.changes.outputs.utilities }}" == "true" ]; then
                UTILITIES_JSON='["array","constants","date","error","logger","middleware","response","validation"]'
              else
                UTILITIES_JSON="[]"
              fi
            fi
          fi
          
          echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
          echo "utilities=$UTILITIES_JSON" >> $GITHUB_OUTPUT
      - name: Log detected packages
        run: |
          echo "=========================================="
          echo "ğŸ“‹ PACKAGE DETECTION SUMMARY"
          echo "=========================================="
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ“¦ Scope: ${{ github.event.inputs.package_scope }}"
            echo "ğŸ”§ Force publish: ${{ github.event.inputs.force_publish }}"
          fi
          echo ""
          echo "ğŸ“Š Services to publish:"
          echo '${{ steps.individual-changes.outputs.services }}' | jq -r '.[]' | sed 's/^/   - @myorg\//' || echo "   - None"
          echo ""
          echo "ğŸ“Š Utilities to publish:"
          echo '${{ steps.individual-changes.outputs.utilities }}' | jq -r '.[]' | sed 's/^/   - @myorg\//' || echo "   - None"
          echo ""
          echo "ğŸ¯ Services changed: ${{ steps.changes.outputs.services }}"
          echo "ğŸ¯ Utilities changed: ${{ steps.changes.outputs.utilities }}"
          echo "=========================================="

      - name: Determine dependency chain requirements
        id: dependency-chain
        run: |
          # Determine what should be published based on changes and trigger type
          SERVICES_CHANGED="${{ steps.changes.outputs.services }}"
          UTILITIES_CHANGED="${{ steps.changes.outputs.utilities }}"
          INDIVIDUAL_SERVICES='${{ steps.individual-changes.outputs.services }}'
          INDIVIDUAL_UTILITIES='${{ steps.individual-changes.outputs.utilities }}'
          
          echo "=========================================="
          echo "ğŸ”— DEPENDENCY CHAIN ANALYSIS"
          echo "=========================================="
          
          # Initialize flags
          PUBLISH_SERVICES_AGGREGATE="false"
          PUBLISH_UTILITIES_AGGREGATE="false"
          PUBLISH_MAIN_PACKAGE="false"
          PUBLISHING_SCOPE="none"
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ğŸ“‹ Trigger: Push to main branch"
            
            # For push events, determine scope based on actual changes
            if [ "$INDIVIDUAL_SERVICES" != "[]" ] || [ "$SERVICES_CHANGED" == "true" ]; then
              PUBLISH_SERVICES_AGGREGATE="true"
              PUBLISH_MAIN_PACKAGE="true"
              if [ "$PUBLISHING_SCOPE" == "none" ]; then
                PUBLISHING_SCOPE="services-and-above"
              else
                PUBLISHING_SCOPE="full-pipeline"
              fi
              echo "âœ… Services changes detected - will publish services aggregate and main package"
            fi
            
            if [ "$INDIVIDUAL_UTILITIES" != "[]" ] || [ "$UTILITIES_CHANGED" == "true" ]; then
              PUBLISH_UTILITIES_AGGREGATE="true"
              PUBLISH_MAIN_PACKAGE="true"
              if [ "$PUBLISHING_SCOPE" == "none" ]; then
                PUBLISHING_SCOPE="utilities-and-above"
              elif [ "$PUBLISHING_SCOPE" == "services-and-above" ]; then
                PUBLISHING_SCOPE="full-pipeline"
              fi
              echo "âœ… Utilities changes detected - will publish utilities aggregate and main package"
            fi
            
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ“‹ Trigger: Manual workflow dispatch"
            echo "ğŸ“¦ Requested scope: ${{ github.event.inputs.package_scope }}"
            
            # For manual dispatch, respect the selected scope
            case "${{ github.event.inputs.package_scope }}" in
              "individual-only")
                PUBLISHING_SCOPE="individual-only"
                echo "ğŸ¯ Scope: Individual packages only"
                ;;
              "aggregate-and-above")
                PUBLISH_SERVICES_AGGREGATE="true"
                PUBLISH_UTILITIES_AGGREGATE="true"
                PUBLISH_MAIN_PACKAGE="true"
                PUBLISHING_SCOPE="aggregate-and-above"
                echo "ğŸ¯ Scope: Aggregate packages and main package"
                ;;
              "main-only")
                PUBLISH_MAIN_PACKAGE="true"
                PUBLISHING_SCOPE="main-only"
                echo "ğŸ¯ Scope: Main package only"
                ;;
              "full-pipeline")
                PUBLISH_SERVICES_AGGREGATE="true"
                PUBLISH_UTILITIES_AGGREGATE="true"
                PUBLISH_MAIN_PACKAGE="true"
                PUBLISHING_SCOPE="full-pipeline"
                echo "ğŸ¯ Scope: Full publishing pipeline"
                ;;
            esac
          fi
          # Set outputs
          echo "should-publish-services-aggregate=$PUBLISH_SERVICES_AGGREGATE" >> $GITHUB_OUTPUT
          echo "should-publish-utilities-aggregate=$PUBLISH_UTILITIES_AGGREGATE" >> $GITHUB_OUTPUT
          echo "should-publish-main-package=$PUBLISH_MAIN_PACKAGE" >> $GITHUB_OUTPUT
          echo "publishing-scope=$PUBLISHING_SCOPE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“Š DEPENDENCY CHAIN DECISIONS:"
          echo "   Services aggregate: $PUBLISH_SERVICES_AGGREGATE"
          echo "   Utilities aggregate: $PUBLISH_UTILITIES_AGGREGATE"
          echo "   Main package: $PUBLISH_MAIN_PACKAGE"
          echo "   Publishing scope: $PUBLISHING_SCOPE"
          echo "=========================================="

  publish-individual-services:
    name: "Publish Individual Services"
    needs: detect-changes
    if: |
      (github.event_name == 'push' && 
       (needs.detect-changes.outputs.individual-services != '[]' || 
        (needs.detect-changes.outputs.services-changed == 'true' && needs.detect-changes.outputs.individual-services == '[]'))) ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.package_scope == 'individual-only' || 
        github.event.inputs.package_scope == 'aggregate-and-above' || 
        github.event.inputs.package_scope == 'full-pipeline') &&
       (needs.detect-changes.outputs.individual-services != '[]' || github.event.inputs.force_publish == 'true'))
    runs-on: codebuild-publish-packages-to-codeartifact-${{ github.run_id }}-${{ github.run_attempt }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.individual-services) }}
    outputs:
      individual-services-status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Get CodeArtifact authorization token
        id: get-token
        run: |
          echo "ğŸ”‘ Getting CodeArtifact authorization token..."
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain myorg \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "âŒ Failed to get CodeArtifact authorization token"
            exit 1
          fi
          
          echo "âœ… CodeArtifact authorization token obtained"
          echo "auth-token=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_OUTPUT

      - name: Get CodeArtifact registry URL
        id: get-registry
        run: |
          REGISTRY_URL=$(aws codeartifact get-repository-endpoint \
            --domain myorg \
            --repository myorg-repo \
            --format npm \
            --query repositoryEndpoint \
            --output text)
          echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT

      - name: Configure npm for CodeArtifact
        run: |
          REGISTRY_HOST=$(echo "${{ steps.get-registry.outputs.registry-url }}" | sed 's|https://||')
          echo "@myorg:registry=${{ steps.get-registry.outputs.registry-url }}" >> ~/.npmrc
          echo "//${REGISTRY_HOST}/:_authToken=${{ steps.get-token.outputs.auth-token }}" >> ~/.npmrc

      - name: Log publishing phase
        run: |
          echo "=========================================="
          echo "ğŸš€ PHASE 1: INDIVIDUAL SERVICES PUBLISHING"
          echo "=========================================="
          echo "ğŸ“¦ Publishing individual service: ${{ matrix.service }}"
          echo "ğŸ“‹ Package: @myorg/${{ matrix.service }}"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          echo "ğŸ“… Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Install dependencies
        run: |
          cd my-lib/services/${{ matrix.service }}
          echo "Installing dependencies for @myorg/${{ matrix.service }}"
          npm install

      - name: Publish individual service
        id: publish
        run: |
          cd my-lib/services/${{ matrix.service }}
          echo "Publishing @myorg/${{ matrix.service }}"
          npm publish
          echo "âœ… Successfully published @myorg/${{ matrix.service }}"
  publish-individual-utilities:
    name: "Publish Individual Utilities"
    needs: detect-changes
    if: |
      (github.event_name == 'push' && 
       (needs.detect-changes.outputs.individual-utilities != '[]' || 
        (needs.detect-changes.outputs.utilities-changed == 'true' && needs.detect-changes.outputs.individual-utilities == '[]'))) ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.package_scope == 'individual-only' || 
        github.event.inputs.package_scope == 'aggregate-and-above' || 
        github.event.inputs.package_scope == 'full-pipeline') &&
       (needs.detect-changes.outputs.individual-utilities != '[]' || github.event.inputs.force_publish == 'true'))
    runs-on: codebuild-publish-packages-to-codeartifact-${{ github.run_id }}-${{ github.run_attempt }}
    strategy:
      fail-fast: false
      matrix:
        utility: ${{ fromJson(needs.detect-changes.outputs.individual-utilities) }}
    outputs:
      individual-utilities-status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get CodeArtifact authorization token
        id: get-token
        run: |
          echo "ğŸ”‘ Getting CodeArtifact authorization token..."
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain myorg \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "âŒ Failed to get CodeArtifact authorization token"
            exit 1
          fi
          
          echo "âœ… CodeArtifact authorization token obtained"
          echo "auth-token=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_OUTPUT
      - name: Get CodeArtifact registry URL
        id: get-registry
        run: |
          REGISTRY_URL=$(aws codeartifact get-repository-endpoint \
            --domain myorg \
            --repository myorg-repo \
            --format npm \
            --query repositoryEndpoint \
            --output text)
          echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT

      - name: Configure npm for CodeArtifact
        run: |
          REGISTRY_HOST=$(echo "${{ steps.get-registry.outputs.registry-url }}" | sed 's|https://||')
          echo "@myorg:registry=${{ steps.get-registry.outputs.registry-url }}" >> ~/.npmrc
          echo "//${REGISTRY_HOST}/:_authToken=${{ steps.get-token.outputs.auth-token }}" >> ~/.npmrc

      - name: Log publishing phase
        run: |
          echo "=========================================="
          echo "ğŸš€ PHASE 1: INDIVIDUAL UTILITIES PUBLISHING"
          echo "=========================================="
          echo "ğŸ“¦ Publishing individual utility: ${{ matrix.utility }}"
          echo "ğŸ“‹ Package: @myorg/${{ matrix.utility }}"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          echo "ğŸ“… Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Install dependencies
        run: |
          cd my-lib/utilities/${{ matrix.utility }}
          echo "Installing dependencies for @myorg/${{ matrix.utility }}"
          npm install

      - name: Publish individual utility
        id: publish
        run: |
          cd my-lib/utilities/${{ matrix.utility }}
          echo "Publishing @myorg/${{ matrix.utility }}"
          npm publish
          echo "âœ… Successfully published @myorg/${{ matrix.utility }}"
  publish-services-aggregate:
    name: "Publish Services Aggregate"
    needs: [detect-changes, publish-individual-services]
    if: |
      always() && 
      (needs.publish-individual-services.result == 'success' || needs.publish-individual-services.result == 'skipped') &&
      ((github.event_name == 'push' && 
        (needs.detect-changes.outputs.services-changed == 'true' || 
         needs.detect-changes.outputs.individual-services != '[]')) ||
       (github.event_name == 'workflow_dispatch' && 
        (github.event.inputs.package_scope == 'aggregate-and-above' || 
         github.event.inputs.package_scope == 'full-pipeline') &&
        (needs.detect-changes.outputs.services-changed == 'true' || github.event.inputs.force_publish == 'true')))
    runs-on: codebuild-publish-packages-to-codeartifact-${{ github.run_id }}-${{ github.run_attempt }}
    outputs:
      services-aggregate-status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get CodeArtifact authorization token
        id: get-token
        run: |
          echo "ğŸ”‘ Getting CodeArtifact authorization token..."
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain myorg \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "âŒ Failed to get CodeArtifact authorization token"
            exit 1
          fi
          
          echo "âœ… CodeArtifact authorization token obtained"
          echo "auth-token=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_OUTPUT

      - name: Get CodeArtifact registry URL
        id: get-registry
        run: |
          REGISTRY_URL=$(aws codeartifact get-repository-endpoint \
            --domain myorg \
            --repository myorg-repo \
            --format npm \
            --query repositoryEndpoint \
            --output text)
          echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT
      - name: Configure npm for CodeArtifact
        run: |
          REGISTRY_HOST=$(echo "${{ steps.get-registry.outputs.registry-url }}" | sed 's|https://||')
          echo "@myorg:registry=${{ steps.get-registry.outputs.registry-url }}" >> ~/.npmrc
          echo "//${REGISTRY_HOST}/:_authToken=${{ steps.get-token.outputs.auth-token }}" >> ~/.npmrc

      - name: Log publishing phase
        run: |
          echo "=========================================="
          echo "ğŸš€ PHASE 2: AGGREGATE SERVICES PUBLISHING"
          echo "=========================================="
          echo "ğŸ“¦ Publishing services aggregate package"
          echo "ğŸ“‹ Package: @myorg/services"
          echo "âœ… Prerequisites: Individual services publishing completed (${{ needs.publish-individual-services.result }})"
          echo "ğŸ“Š Individual services published: ${{ needs.detect-changes.outputs.individual-services }}"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          echo "ğŸ“… Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Wait for individual packages availability
        run: |
          echo "Waiting briefly for individual packages to be available in registry..."
          sleep 10

      - name: Install dependencies
        run: |
          cd my-lib/services
          echo "Installing dependencies for @myorg/services aggregate"
          npm install

      - name: Build and publish services aggregate
        id: publish
        run: |
          cd my-lib/services
          echo "Publishing @myorg/services aggregate package"
          npm publish
          echo "âœ… Successfully published @myorg/services aggregate"
  publish-utilities-aggregate:
    name: "Publish Utilities Aggregate"
    needs: [detect-changes, publish-individual-utilities]
    if: |
      always() && 
      (needs.publish-individual-utilities.result == 'success' || needs.publish-individual-utilities.result == 'skipped') &&
      ((github.event_name == 'push' && 
        (needs.detect-changes.outputs.utilities-changed == 'true' || 
         needs.detect-changes.outputs.individual-utilities != '[]')) ||
       (github.event_name == 'workflow_dispatch' && 
        (github.event.inputs.package_scope == 'aggregate-and-above' || 
         github.event.inputs.package_scope == 'full-pipeline') &&
        (needs.detect-changes.outputs.utilities-changed == 'true' || github.event.inputs.force_publish == 'true')))
    runs-on: codebuild-publish-packages-to-codeartifact-${{ github.run_id }}-${{ github.run_attempt }}
    outputs:
      utilities-aggregate-status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get CodeArtifact authorization token
        id: get-token
        run: |
          echo "ğŸ”‘ Getting CodeArtifact authorization token..."
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain myorg \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "âŒ Failed to get CodeArtifact authorization token"
            exit 1
          fi
          
          echo "âœ… CodeArtifact authorization token obtained"
          echo "auth-token=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_OUTPUT

      - name: Get CodeArtifact registry URL
        id: get-registry
        run: |
          REGISTRY_URL=$(aws codeartifact get-repository-endpoint \
            --domain myorg \
            --repository myorg-repo \
            --format npm \
            --query repositoryEndpoint \
            --output text)
          echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT
      - name: Configure npm for CodeArtifact
        run: |
          REGISTRY_HOST=$(echo "${{ steps.get-registry.outputs.registry-url }}" | sed 's|https://||')
          echo "@myorg:registry=${{ steps.get-registry.outputs.registry-url }}" >> ~/.npmrc
          echo "//${REGISTRY_HOST}/:_authToken=${{ steps.get-token.outputs.auth-token }}" >> ~/.npmrc

      - name: Log publishing phase
        run: |
          echo "=========================================="
          echo "ğŸš€ PHASE 2: AGGREGATE UTILITIES PUBLISHING"
          echo "=========================================="
          echo "ğŸ“¦ Publishing utilities aggregate package"
          echo "ğŸ“‹ Package: @myorg/utilities"
          echo "âœ… Prerequisites: Individual utilities publishing completed (${{ needs.publish-individual-utilities.result }})"
          echo "ğŸ“Š Individual utilities published: ${{ needs.detect-changes.outputs.individual-utilities }}"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          echo "ğŸ“… Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Wait for individual packages availability
        run: |
          echo "Waiting briefly for individual packages to be available in registry..."
          sleep 10

      - name: Install dependencies
        run: |
          cd my-lib/utilities
          echo "Installing dependencies for @myorg/utilities aggregate"
          npm install

      - name: Build and publish utilities aggregate
        id: publish
        run: |
          cd my-lib/utilities
          echo "Publishing @myorg/utilities aggregate package"
          npm publish
          echo "âœ… Successfully published @myorg/utilities aggregate"
  publish-main-package:
    name: "Publish Main Package"
    needs: [detect-changes, publish-services-aggregate, publish-utilities-aggregate]
    if: |
      always() && 
      (
        (needs.publish-services-aggregate.result == 'success' && needs.publish-utilities-aggregate.result == 'success') ||
        (needs.publish-services-aggregate.result == 'success' && needs.publish-utilities-aggregate.result == 'skipped') ||
        (needs.publish-services-aggregate.result == 'skipped' && needs.publish-utilities-aggregate.result == 'success')
      ) &&
      ((github.event_name == 'push' && 
        (needs.detect-changes.outputs.services-changed == 'true' || 
         needs.detect-changes.outputs.utilities-changed == 'true' ||
         needs.detect-changes.outputs.individual-services != '[]' ||
         needs.detect-changes.outputs.individual-utilities != '[]')) ||
       (github.event_name == 'workflow_dispatch' && 
        (github.event.inputs.package_scope == 'main-only' || 
         github.event.inputs.package_scope == 'full-pipeline') &&
        (needs.detect-changes.outputs.services-changed == 'true' || needs.detect-changes.outputs.utilities-changed == 'true' || github.event.inputs.force_publish == 'true')))
    runs-on: codebuild-publish-packages-to-codeartifact-${{ github.run_id }}-${{ github.run_attempt }}
    outputs:
      main-package-status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get CodeArtifact authorization token
        id: get-token
        run: |
          echo "ğŸ”‘ Getting CodeArtifact authorization token..."
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain myorg \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "âŒ Failed to get CodeArtifact authorization token"
            exit 1
          fi
          
          echo "âœ… CodeArtifact authorization token obtained"
          echo "auth-token=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_OUTPUT
      - name: Get CodeArtifact registry URL
        id: get-registry
        run: |
          REGISTRY_URL=$(aws codeartifact get-repository-endpoint \
            --domain myorg \
            --repository myorg-repo \
            --format npm \
            --query repositoryEndpoint \
            --output text)
          echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT

      - name: Configure npm for CodeArtifact
        run: |
          REGISTRY_HOST=$(echo "${{ steps.get-registry.outputs.registry-url }}" | sed 's|https://||')
          echo "@myorg:registry=${{ steps.get-registry.outputs.registry-url }}" >> ~/.npmrc
          echo "//${REGISTRY_HOST}/:_authToken=${{ steps.get-token.outputs.auth-token }}" >> ~/.npmrc

      - name: Log publishing phase
        run: |
          echo "=========================================="
          echo "ğŸš€ PHASE 3: MAIN PACKAGE PUBLISHING"
          echo "=========================================="
          echo "ğŸ“¦ Publishing main package"
          echo "ğŸ“‹ Package: @myorg/libraries"
          echo "âœ… Prerequisites:"
          echo "   - Services aggregate: ${{ needs.publish-services-aggregate.result }}"
          echo "   - Utilities aggregate: ${{ needs.publish-utilities-aggregate.result }}"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          echo "ğŸ“… Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Verify aggregate publishing prerequisites
        run: |
          SERVICES_STATUS="${{ needs.publish-services-aggregate.result }}"
          UTILITIES_STATUS="${{ needs.publish-utilities-aggregate.result }}"
          
          echo "Verifying aggregate publishing prerequisites..."
          
          if [ "$SERVICES_STATUS" == "failure" ] || [ "$UTILITIES_STATUS" == "failure" ]; then
            echo "âŒ Cannot publish main package: One or more aggregate packages failed to publish"
            echo "Services aggregate: $SERVICES_STATUS"
            echo "Utilities aggregate: $UTILITIES_STATUS"
            exit 1
          fi
          
          if [ "$SERVICES_STATUS" == "success" ] || [ "$UTILITIES_STATUS" == "success" ]; then
            echo "âœ… Prerequisites met: At least one aggregate package published successfully"
            echo "Services aggregate: $SERVICES_STATUS"
            echo "Utilities aggregate: $UTILITIES_STATUS"
          else
            echo "âŒ Cannot publish main package: No aggregate packages were published successfully"
            exit 1
          fi
      - name: Wait for aggregate packages availability
        run: |
          echo "Waiting for aggregate packages to be available in registry..."
          sleep 15

      - name: Install dependencies
        run: |
          cd my-lib
          echo "Installing dependencies for @myorg/libraries main package"
          npm install

      - name: Publish main package
        id: publish
        run: |
          cd my-lib
          echo "Publishing @myorg/libraries main package"
          npm publish
          echo "âœ… Successfully published @myorg/libraries main package"

      - name: Log completion status
        if: always()
        run: |
          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "âœ… Main package publishing completed successfully"
            echo "ğŸ‰ Full publishing pipeline completed!"
          else
            echo "âŒ Main package publishing failed"
            exit 1
          fi
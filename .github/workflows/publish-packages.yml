# GitHub Actions Workflow for CodeArtifact Package Publishing
# 
# This workflow runs on AWS CodeBuild managed runners for package publishing.
# Uses CodeBuild infrastructure directly instead of GitHub-hosted runners.
# 
# INFRASTRUCTURE:
# - Uses CodeBuild managed runner: codebuild-publish-packages-to-codeartifact
# - Build Environment: Amazon Linux 2, x86_64, Standard 7.0
# - Compute: BUILD_GENERAL1_SMALL
# - Service Role: CodeBuildServiceRole-PackagePublishing with CodeArtifact permissions
# 
# AUTOMATIC TRIGGERING:
# - Triggers on push to main branch with changes in my-lib/**
# - Primary method should be CodeBuild webhook (faster, more direct)
# 
# MANUAL TRIGGERING:
# - Use when CodeBuild webhook is not working
# - Go to Actions tab ‚Üí "Publish Packages to CodeArtifact" ‚Üí "Run workflow"
# - Options:
#   - reason: Describe why manual trigger is needed
#   - force_build: Build even without my-lib changes (for testing)
# 
# WHEN TO USE MANUAL TRIGGER:
# - CodeBuild webhook is not responding
# - Testing the CodeBuild managed runner
# - Emergency package publishing
# - Debugging build issues on CodeBuild infrastructure
#
name: Publish Packages to CodeArtifact

# Configuration - Update these values to match your CodeBuild setup
# These should match the values used in scripts/setup-codebuild.js
env:
  CODEBUILD_PROJECT_NAME: publish-packages-to-codeartifact  # Must match PROJECT_NAME in setup-codebuild.js
  LOG_GROUP_NAME: /aws/codebuild/publish-packages-to-codeartifact
  # CodeBuild infrastructure configuration
  CODEBUILD_REGION: ${{ secrets.AWS_REGION }}
  CODEBUILD_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

on:
  # Primary trigger: Push to main branch with my-lib changes
  push:
    branches: [ main ]
    paths:
      - 'my-lib/**'
  
  # Manual/fallback trigger: Use when CodeBuild webhook is not working
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger (e.g., webhook not working, testing)'
        required: false
        default: 'Manual trigger'
      force_build:
        description: 'Force build even if no my-lib changes detected'
        type: boolean
        required: false
        default: false

jobs:
  trigger-codebuild:
    # Use CodeBuild managed runner - matches the CodeBuild project configuration
    # This runs directly on CodeBuild infrastructure instead of GitHub-hosted runners
    runs-on: codebuild-publish-packages-to-codeartifact-${{ github.run_id }}-${{ github.run_attempt }}
    env:
      # CodeBuild project configuration - matches setup-codebuild.js settings
      CODEBUILD_PROJECT_TYPE: "LINUX_CONTAINER"
      CODEBUILD_COMPUTE_TYPE: "BUILD_GENERAL1_SMALL"  # Matches setup-codebuild.js
      CODEBUILD_IMAGE: "aws/codebuild/standard:7.0"   # Matches setup-codebuild.js
      CODEBUILD_SERVICE_ROLE: "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/CodeBuildServiceRole-PackagePublishing"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Fetch previous commit for change detection
    
    - name: Check trigger type and validate changes
      id: check-trigger
      run: |
        echo "Checking trigger type and validating changes..."
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "üîß Manual trigger detected"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Force build: ${{ github.event.inputs.force_build }}"
          echo "trigger-type=manual" >> $GITHUB_OUTPUT
          
          if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
            echo "‚úÖ Force build enabled - proceeding with build"
            echo "should-build=true" >> $GITHUB_OUTPUT
          else
            echo "üîç Checking for my-lib changes in manual trigger..."
            if git diff --name-only HEAD~1 HEAD | grep -q "^my-lib/"; then
              echo "‚úÖ my-lib changes detected - proceeding with build"
              echo "should-build=true" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è  No my-lib changes detected. Use 'force_build' option to build anyway."
              echo "should-build=false" >> $GITHUB_OUTPUT
            fi
          fi
        else
          echo "ü§ñ Automatic trigger detected (push to main with my-lib changes)"
          echo "trigger-type=automatic" >> $GITHUB_OUTPUT
          echo "should-build=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Skip build notification
      if: steps.check-trigger.outputs.should-build == 'false'
      run: |
        echo "‚è≠Ô∏è  Skipping build - no my-lib changes detected"
        echo "To force a build, re-run this workflow with 'force_build' enabled"
        echo "Or make changes to files in the my-lib directory"
    
    - name: Configure AWS credentials
      if: steps.check-trigger.outputs.should-build == 'true'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Verify AWS authentication
      if: steps.check-trigger.outputs.should-build == 'true'
      run: |
        echo "Testing AWS authentication..."
        if ! aws sts get-caller-identity > /dev/null 2>&1; then
          echo "‚ùå AWS authentication failed. Please check your GitHub secrets:"
          echo "  - AWS_ACCESS_KEY_ID"
          echo "  - AWS_SECRET_ACCESS_KEY" 
          echo "  - AWS_REGION"
          echo "Make sure the credentials have permissions to access CodeBuild."
          exit 1
        fi
        echo "‚úÖ AWS authentication successful"
        aws sts get-caller-identity
    
    - name: Display CodeBuild runner configuration
      if: steps.check-trigger.outputs.should-build == 'true'
      run: |
        echo "üèóÔ∏è  CodeBuild Managed Runner Configuration:"
        echo "Runner: codebuild-$CODEBUILD_PROJECT_NAME"
        echo "Environment Type: $CODEBUILD_PROJECT_TYPE"
        echo "Compute Type: $CODEBUILD_COMPUTE_TYPE"
        echo "Build Image: $CODEBUILD_IMAGE"
        echo "Service Role: $CODEBUILD_SERVICE_ROLE"
        echo "Region: $CODEBUILD_REGION"
        echo "Account ID: $CODEBUILD_ACCOUNT_ID"
        echo "Running directly on CodeBuild infrastructure"
    
    - name: Setup Node.js and dependencies
      if: steps.check-trigger.outputs.should-build == 'true'
      run: |
        echo "üîß Setting up Node.js environment..."
        
        # Install Node.js if not available (CodeBuild standard:7.0 includes Node.js)
        node --version || (echo "Installing Node.js..." && curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs)
        npm --version
        
        echo "üì¶ Installing project dependencies..."
        npm install
    
    - name: Get CodeArtifact authorization token
      if: steps.check-trigger.outputs.should-build == 'true'
      id: get-token
      run: |
        echo "üîë Getting CodeArtifact authorization token..."
        
        # Get authorization token from CodeArtifact
        CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
          --domain myorg \
          --query authorizationToken \
          --output text)
        
        if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
          echo "‚ùå Failed to get CodeArtifact authorization token"
          exit 1
        fi
        
        echo "‚úÖ CodeArtifact authorization token obtained"
        echo "auth-token=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_OUTPUT
    
    - name: Build and publish packages
      if: steps.check-trigger.outputs.should-build == 'true'
      run: |
        echo "üèóÔ∏è  Building and publishing packages to CodeArtifact..."
        
        # Navigate to my-lib directory
        cd my-lib
        
        # Install dependencies for all packages
        echo "üì¶ Installing dependencies for all packages..."
        npm run install:all
        
        # Publish packages to CodeArtifact
        echo "üì§ Publishing packages to CodeArtifact..."
        CODEARTIFACT_AUTH_TOKEN="${{ steps.get-token.outputs.auth-token }}" npm run publish:all
        
        echo "‚úÖ Package publishing completed successfully!"
    
    - name: Report build success
      if: success() && steps.check-trigger.outputs.should-build == 'true'
      run: |
        echo "üéâ Package publishing completed successfully on CodeBuild managed runner!"
        echo "Trigger type: ${{ steps.check-trigger.outputs.trigger-type }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "Manual reason: ${{ github.event.inputs.reason }}"
        fi
        echo "Runner: codebuild-$CODEBUILD_PROJECT_NAME"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"
        echo "Repository: ${{ github.repository }}"
    
    - name: Report build failure
      if: failure() && steps.check-trigger.outputs.should-build == 'true'
      run: |
        echo "üí• Package publishing failed on CodeBuild managed runner!"
        echo "Trigger type: ${{ steps.check-trigger.outputs.trigger-type }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "Manual reason: ${{ github.event.inputs.reason }}"
        fi
        echo "Runner: codebuild-$CODEBUILD_PROJECT_NAME"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"
        echo "Repository: ${{ github.repository }}"
        echo ""
        echo "Please check:"
        echo "1. CodeBuild managed runner configuration"
        echo "2. AWS credentials and CodeArtifact permissions"
        echo "3. Package dependencies and build scripts"
        echo "4. CodeArtifact domain and repository setup"
        echo ""
        echo "üí° Troubleshooting tips:"
        echo "- Check GitHub Actions logs for detailed error messages"
        echo "- Verify CodeArtifact authorization token generation"
        echo "- Ensure my-lib packages have valid package.json files"
        echo "- Check npm registry configuration"
        exit 1